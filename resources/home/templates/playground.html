{% extends "home.html" %}

{% block title %}Playground{% endblock %}

{% block script %}
  // constants for text generation eta
  var TIME_CONSTANT = 3;
  var TIME_PER_TOKEN = 0.12;

  var EXAMPLES = {
    "news": {
      "prompt": "VECTOR INSTITUTE DEVELOPS ARTIFICIAL INTELLIGENCE FOR HEALTH RECOMMENDATIONS",
      "length": 256
    },
    "arxiv": {
      "prompt": "Abstract\n\nWe introduce large language models, models that",
      "length": 256
    },
    "chatbot": {
      "prompt": "A chat between a teacher and student who wants to learn about tacos.\n\nTeacher: Hi there. What would you like to learn about today?\nStudent:",
      "length": 128
    },
    "question": {
      "prompt": "Question: What color is the sky?\nAnswer: blue\n\nQuestion: Who was the first prime minister of Canada?\nAnswer: Robert Walpole\n\nQuestion: Who is the prime minister in 2022?\nAnswer:",
      "length": 64
    },
    "poetry": {
      "prompt": "A sonnet about life\n\n",
      "length": 128
    },
    "none": {
      "prompt": "",
      "length": 128,
      "temperature": 1,
      "top-p": 0.9,
      "top-k": 0.0,
      "repetition-penalty": 1.0,
      "num-return-sequences": 1
    }
  };

  function setPrompt(name) {
    if (name == "none") {
      $("#textbox-input").html(EXAMPLES[name]["prompt"]);
      $("#response-length-select").val(EXAMPLES[name]["length"]);
      $("#response-length-value").val(EXAMPLES[name]["length"]);
      $("#temperature-select").val(EXAMPLES[name]["temperature"]);
      $("#temperature-value").val(EXAMPLES[name]["temperature"]);
      $("#top-p-select").val(EXAMPLES[name]["top-p"]);
      $("#topp-value").val(EXAMPLES[name]["top-p"]);
      $("#top-k-select").val(EXAMPLES[name]["top-k"]);
      $("#repetition-penalty-select").val(EXAMPLES[name]["repetition-penalty"]);
      $("#repetition-penalty-value").val(EXAMPLES[name]["repetition-penalty"]);
      $("#num-return-sequence-select").val(EXAMPLES[name]["num-return-sequences"]);
    }
    else {
      $("#response-length-select").val(EXAMPLES[name]["length"]);
      $("#response-length-value").val(EXAMPLES[name]["length"]);
      $("#textbox-input").html(EXAMPLES[name]["prompt"]);
    }
  };

  // model instances request
  function loadInstances(){
    $.ajax({
      url : "/models/instances",
      type : "GET",
      success : function (data){
        console.log(data);
        for (const model in data) {
          var currentModel= $('#'+model)
          if (data[model] == "Active"){
            currentModel.attr("title", "Active service!");
            currentModel.prop('disabled', false);
            currentModel.text(model);
            currentModel.val(model);
          }
          else{
            var selectedModel= $("#model-select option:selected");
            if (selectedModel.val() == model){
              $("#model-select").val('');
            }
            currentModel.attr("title", "Inactive model: please start its model service!");
            currentModel.prop('disabled', true);
            currentModel.text(model + " (Inactive)");
          }
        }
      }
    });
  }

  loadInstances() // fetch upon page refresh

  setInterval(function(){
    loadInstances() // fetch model instances every 10 seconds
  }, 10000);

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // text generation request
  $(document).ready(function () {
    $("#text-submit").submit(function (event) {
      loadAnimation();
      getPromptText();
      var selectedModel = document.getElementById("model-select");
      var formData= getFormData();
      console.log(JSON.stringify(formData))
      $.ajax({
        url: "/models/" + selectedModel.options[selectedModel.selectedIndex].value + "/generate_text",
        type: "POST",
        headers: {
          "Authorization": "Bearer " + getCookie(access_token_cookie)
        },
        data: formData
      }).done(function (data) {
        loadCompleteAnimation();
        parseData(data);
        console.log(data);
      }).fail(function (data) {
          console.log(data)
          window.href = '/login'
          loadFailAnimation();
        });
      event.preventDefault();
    });
  });

  function getFormData() {
    unstructuredFormData= $("#text-submit").serializeArray();
    submissionData= {};
    $.map(unstructuredFormData, function( input, i ) {
      submissionData[input.name] = input.value;
    });
    return submissionData
  };

  function parseData(data){
    //TODO: refactor data processing based upon request data tokens
    $("span").removeClass("generated-text-font");
    var text= data['tokens'];
    var logProbTokens= data['logprobs'];
    textWrapper= $("<span></span>");
    try {
      var logProbs= [];
      logProbTokens.forEach(token =>{
        var logProbPercentage= (Math.exp(token)*100).toFixed(3);
        logProbs.push(logProbPercentage);
      });
    }
    catch (err) {
      console.log("Log probability calculation error: " + err);
    }
    finally {
      for(let i=0; i<text.length; i++){
        var textPanel= "<div><b>Log Probabilities</b></div><hr><div><b>"+text[i]+"</b>= "+logProbs[i]+"% </div>";
        labelledText= $("<span class='generated-text' tabindex='0' data-trigger='hover' data-html='true' data-placement='bottom' data-content='"+textPanel+"'></span>").text(text[i]);
        textWrapper.append(labelledText.popover());
      }
      textWrapper.addClass("generated-text-font");
      $("#textbox-input").append(textWrapper);
    }
  };

  function loadAnimation() {
    getTextGenerationETA();
    document.getElementById("loader").style.display = "inline";
    document.getElementById("submit-button").style.display = "none";
  };

  function getTextGenerationETA(){
    var responseLength = $("#response-length-select").val();
    var eta = Math.round(TIME_PER_TOKEN * responseLength + TIME_CONSTANT);
    $("#eta").text(eta);
  }

  function loadCompleteAnimation() {
    document.getElementById("loader").style.display = "none";
    document.getElementById("submit-button").style.display = "inline";
    document.getElementById("textbox-input").style.backgroundColor = "#f6fef6";
  };

  function loadFailAnimation() {
    document.getElementById("loader").style.display = "none";
    document.getElementById("submit-button").style.display = "inline";
    document.getElementById("textbox-input").style.backgroundColor = "#ffebeb";
  };

  function clearText(){
    setPrompt("none");
    document.getElementById("textbox-input").style.backgroundColor = "transparent";
  };

  function getPromptText(){
    document.getElementById("textbox").value= document.getElementById("textbox-input").outerText;
  };

  function updateScrollValue(val, id) {
    document.getElementById(id).value = val;
  };

  function updateModuleNames(model) {
    $.get("/models/" + model + "/module_names", 
    function( data ) {
      for(let i=0; i<data['module_names'].length; i++){
        moduleNameOption= $("<option value="+data['module_names'][i]+"></option>").text(data['module_names'][i])
        $("#module-name-select").append(moduleNameOption);
      }
    });
  };

  window.onload = function () {
    if (document.cookie.indexOf("access_token_cookie=") == -1) {
      window.href = '/login'
    } 
    document.getElementById("loader").style.display = "none";
  };

  $(function () {
    $('[data-toggle="popover"]').popover({
          delay: {show:1000}
      })
  })
{% endblock %}

{% block style %}
  .placeholder:empty:before {
    content: attr(data-placeholder);
    opacity: 0.5;
  }
  .textarea {
    -moz-appearance: textfield-multiline;
    -webkit-appearance: textarea;
    overflow: auto;
    resize: vertical;
    white-space:pre-wrap;
    height:65vh;
  }
  .parameter-list {
    overflow-y: scroll;
    height: 70vh;
  }
  .scrollbar::-webkit-scrollbar {
    width: 2px;
  }
  .scrollbar::-webkit-scrollbar-track {
    border-radius: 10px;
    box-shadow: inset 0 0 8px #0000001a;
  }
  .parameter-list::-webkit-scrollbar-track {
    margin-top: 3vh;
  }
  .scrollbar::-webkit-scrollbar-thumb {
    background: #007bff;
    border-radius: 10px;
    height: 5px;
  }
  .generated-text-font {
    font-weight: bold;
  }
  .generated-text:hover { 
    background-color: yellow;
  }
{% endblock %}

{% block body %}
  <div class="mt-3 px-5">
    <div class="row">
      <!-- main column -->
      <div class="col">
        <div class="row-fluid">
          <div class="d-inline-block">
            <h3 class="d-inline-block">Playground</h3>
            <nav class="navbar navbar-expand-sm navbar-light d-inline-block">
              <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleSubNavbar">
                  <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="collapsibleSubNavbar">
                  <ul class="nav">
                    <li class="nav-item dropdown">
                      <a class="nav-link dropdown-toggle text-dark" data-toggle="dropdown" role="button" aria-haspopup="true"
                        aria-expanded="false">Examples</a>
                      <div class="dropdown-menu">
                        <a class="dropdown-item" href='javascript:setPrompt("news");'><i class="bi bi-newspaper"></i> News</a>
                        <a class="dropdown-item" href='javascript:setPrompt("arxiv");'><i class="bi bi-file-text"></i> ML paper</a>
                        <a class="dropdown-item" href='javascript:setPrompt("chatbot");'><i class="bi bi-chat-left-dots-fill"></i> Chatbot</a>
                        <a class="dropdown-item" href='javascript:setPrompt("question");'><i class="bi bi-question-circle"></i> QA</a>
                        <a class="dropdown-item" href='javascript:setPrompt("poetry");'><i class="bi bi-brush"></i> Poetry</a>
                      </div>
                    </li>
                    <!-- <li class="nav-item">
                      <a class="nav-link" href="#">Embed</a>
                    </li> -->
                    <!-- <li class="nav-item">
                      <a class="nav-link disabled" href="#">Benchmark</a>
                    </li> -->
                  </ul>
                </div>
              </div>
            </nav>
          </div>
        </div>
        <div class="row-fluid">
          <form>
            <div class="form-group">
              <textarea class="form-control" id="textbox" name="prompt" placeholder="Enter a prompt..."
                form="text-submit" style="display:none;"></textarea>
              <div class="textarea form-control scrollbar placeholder" id="textbox-input" data-placeholder="Enter a prompt..." contenteditable="true"></div>
            </div>
          </form>
        </div>
      </div>
      <!-- configurations column -->
      <div class="col-sm-3 col-auto scrollbar parameter-list p-4">
        <form id="text-submit" name="submit-form">
          <div class="form-group">
            <label for="model-select">Model</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover" title="Models"
            data-placement="auto"
            data-content="The large language model which will generate text. Some models are suitable for specified tasks."></i>
            <select class="form-control" id="model-select" onchange="updateModuleNames(this.value);" required>
              <option selected id="null-model" disabled value="">Select A Model</option>  
              {% for types in all_models %}
                  <option disabled id="{{ types }}" value="{{ types }}" title="Inactive model: please start its model service!">{{ types }} (Inactive)</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="response-length-select">Response Length</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover" title="Response Length"
            data-placement="top" data-content="An integer to define the maximum number of tokens to generate."></i>
            <output class="float-right" id="response-length-value">128</output>
            <input type="range" class="custom-range" id="response-length-select" value=128 name="max-tokens" placeholder=128
              max=512 min=1 oninput="updateScrollValue(this.value, 'response-length-value');">
          </div>
          <div class="form-group">
            <label for="temperature-select">Temperature</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover" title="Temperature"
            data-placement="top" data-content="A decimal to define the temperature of the sampling operation."></i>
            <output class="float-right" id="temperature-value">1</output>
            <input type="range" class="custom-range" id="temperature-select" value=1 name="temperature" placeholder=1
              max=1 step=0.1 min=0.1 oninput="updateScrollValue(this.value, 'temperature-value');">
          </div>
          <div class="form-group">
            <label for="top-p-select">Top-P</label><i class="bi bi-info-circle small px-1"  tabindex="0" data-toggle="popover" data-trigger="hover" title="Top-P"
            data-placement="top"
            data-content="A decimal to define the tokens that are within the sample operation of text generation"></i>
            <output class="float-right" id="topp-value">0.9</output>
            <input type="range" class="custom-range" id="top-p-select" value=0.9 name="top-p" placeholder=0.9 max=1 step=0.1
              min=0.1 oninput="updateScrollValue(this.value, 'topp-value');">
          </div>
          <div class="form-group">
            <label for="top-k-select">Top-K</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover" title="Top-K"
            data-placement="top"
            data-content="An integer to define the top tokens considered within the sample operation to create new text"></i>
            <input type="number" class="form-control" id="top-k-select" value=0.0 name="top-k" placeholder=1.0 max=100.0
              step=0.1 min=0.0>
          </div>
          <div class="form-group">
            <label for="repetition-penalty-select">Repetition Penalty</label><i class="bi bi-info-circle small px-1"  tabindex="0" data-toggle="popover" data-trigger="hover" title="Repetition Penalty"
            data-placement="top"
            data-content="The more frequently a token is used within text generation the more it is penalized to not be picked in successive generation passes."></i>
            <output class="float-right" id="repetition-penalty-value">1.0</output>
            <input type="range" class="custom-range" id="repetition-penalty-select" value=1.0 name="repetition_penalty"
              placeholder=1.0 max=100.0 step=1.0 min=0.0
              oninput="updateScrollValue(this.value, 'repetition-penalty-value');">
          </div>
          <div class="form-group">
            <label for="num-return-sequence-select">Number Return Sequences</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover"
            title="Number Return Sequences" data-placement="top"
            data-content="An integer to define the proposition that is desired to be returned."></i>
            <input type="number" class="form-control" id="num-return-sequence-select" value=1 name="repetition_penalty"
              placeholder=1>
          </div>
          <div class="form-group">
            <label for="module-name-select">Module Name</label><i class="bi bi-info-circle small px-1" tabindex="0" data-toggle="popover" data-trigger="hover" title="Module Name"
            data-placement="top"
            data-content="Information to display how likely was a token to be generated."></i>
            <select class="form-control" id="module-name-select" required>
              <option selected="true">Show None</option>
            </select>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- footer panel -->
  <div class="fixed-bottom bg-white">
    <div class="form-row py-3 d-flex justify-content-center align-items-center">
      <div class="col-auto">
        <button class="btn bg-success text-white" type="submit" value="submit" form="text-submit"
        id="submit-button">Submit</button>
      </div>
      <div class="col-auto">
        <button class="btn bg-success text-white" type="button" id="loader" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Appx. <span id="eta">X</span> seconds
        </button>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-light" onclick='clearText();' tabindex="0" data-toggle="popover" data-trigger="hover"
        data-placement="auto"
        data-content="Reset configurations and clear textbox">Clear</button>
      </div>
      <!-- <div class="col-auto">
        <button type="button" class="btn btn-light" onclick='clearText();' tabindex="0" data-toggle="popover" data-trigger="hover"
        data-placement="auto" data-content="Awesome generation! &#128578;"><i class="bi bi-hand-thumbs-up-fill"></i></button>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-light" onclick='clearText();' tabindex="0" data-toggle="popover" data-trigger="hover"
        data-placement="auto" data-content="Needs improvement &#128528;"><i class="bi bi-hand-thumbs-down-fill"></i></button> 
      </div> -->
    </div>
    <footer class="navbar-custom text-center">
      <a class="text-white small">© 2022 Vector Institute</a>
    </footer>
  </div>
{% endblock %}
